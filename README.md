# XQuery v2.0

## Setup For Testing Milestone 1

Note: As of this writing, there is a minor bug in XQ v2.0 which prevents it
from indexing the AVAX blockchain past block height 2433078.

### Dependencies & Requirements

- python 3.8 or 3.9
- docker version 20.10
- docker compose version v2.3.4
- alembic 1.8.0
- Ensure no containers or services are listening on any of the
  following ports: `5432`, `6379`, `8080`

### Clone This Repository and Enter Cloned Repo

```shell
git clone https://github.com/blocknetdx/xquery-v2-testing
cd xquery-v2-testing
```

### Set Up & Activate Virtual Environment

```shell
virtualenv -p python3 ./.venv
source .venv/bin/activate

pip install -r requirements.txt
```

#### Errors running pip install -r requirements.txt

If `pip install -r requirements.txt` returns error messages about not
being able to compile/install the package `psycopg2`, edit
`requirements.txt` and change this line:
```
psycopg2[binary]==2.9.3
```
to this:
```
psycopg2-binary==2.9.3
```
Then issue once again:
```shell
pip install -r requirements.txt
```

### Configuration

All configurable settings are consolidated in `xquery/config.py`. Generally, no other files need to be modified!
The `xquery/config.py` file included in this repo should be considered
as an example/template. Feel free to change configs as desired.
For example, the web3 provider RPC URLs in this template config are as
follows:
```py
    # web3 provider RPC url
    "API_URL": {
        "ETH": None,
        "AVAX": "https://api.avax.network/ext/bc/C/rpc",
        "SYS": "https://rpc.syscoin.org/",
    },
```
This configures XQ to fetch blockchain data for AVAX from the public
AVAX blockchain source, "https://api.avax.network/ext/bc/C/rpc". That
works fine, but that source of AVAX data is rate limited. If you have
AVAX running locally and you want to ensure AVAX indexing speed is not
limited by the source of AVAX blockchain data, you may wish to change
this section of the config file to be something like this:
```py
    # web3 provider RPC url
    "API_URL": {
        "ETH": None,
        "AVAX": "http://172.31.11.28:9650/ext/bc/C/rpc",
        "SYS": "https://rpc.syscoin.org/",
    },
```
...where `172.31.11.28` is the IP of the local `avax` container.
If you are running a local SYS container or ETH container, you may
wish to also adjust their web3 provider RPC URLs to reference local,
unlimited rate sources.

### Launch Postgres, Redis & Hasura containers

```shell
cd contrib
cp .env.template .env
./run.sh
cd ..
```

## Database

Run the following commands to create the database tables.

```shell
alembic -n default -c alembic/alembic.ini revision --autogenerate -m 'creating schema'
alembic -n default -c alembic/alembic.ini upgrade head
```

### Run Example

```shell
python -m run 2> run.log &
```
The above command starts the indexing of AVAX blockchain into a
database stored on a (temporary) volume attached to the `xquery-pg`
(postgres) container. (Modify `run.py` before issuing this command to have it index other EVMs.)
Logs generated by `python -m run` are streamed to STDERR, which is why
this example redirects STDERR to a file with `2> run.log`, and runs the
`run` module in the background with `&` at the end.
To watch the streaming logs, you can issue:
```shell
tail -f run.log
```
Then issue ^C to interrupt the scrolling logs.
To interrupt the `python -m run` command:
```shell
# bring the python -m run process to the foreground:
fg
# then interrupt the python -m run process by issuing (at least one) ^C
```

(Instead of issuing `python -m run 2> run.log &`, one could alternatively open a `tmux` window, activate the same
virtual environment there with `source .venv/bin/activate`, then issue `python -m run` in the tmux
window and let the logs scroll within the tmux window.)

### Verify Indexed Data in Hasura Console

Find the IP of the server where XQuery v2 is running:
```
curl ifconfig.co
# OR
curl ifconfig.io
```
Note the IP of your server, which we'll refer to here as `<SERVER-IP>`

Navigate in a web browser to:
```
http://<SERVER-IP>:8080/console
```
This should give you a graphical Hasura GraphQL interface to the
database indexed by XQuery v2. You can make specific queries for
specific blocks through this GUI, then compare the query results to
the information given in Blockchain Explorers.

#### Add Tables to Hasura Console

The first time you navigate in a web browser to
`http://<SERVER-IP>:8080/console`, you'll probably see some message
about not having any tables available to query from, and a suggestion
to click the **Data** tab above to add/create some tables. Follow this
suggestion and click the **Data** tab. Upon clicking the **Data** tab,
click the **public** tab on the left. At this point, you should be
given the option to add/create the following tables, and you should add all
of them:
```
alembic_version
indexer_state
processor_state
xquery
```
The only table of real interest is the `xquery` table, which is where
you can query for indexed EVM data. The `indexer_state` table might
also be of interest, as it provides data about the most recently
indexed block.

The following image shows where the **Data** and **public** tabs are
located on the Hasura Console screen:

![Hasura Console](https://github.com/blocknetdx/xquery-v2-testing/blob/main/img/hasura.png?raw=true)

## Tests

> WARNING: Some tests currently affect the state of the cache and database. Only run on a development setup!

```shell
pytest --collect-only tests/
pytest --collect-only -k="cache" tests/

pytest -v tests/
pytest -v -k="cache" tests/
```

## Benchmarks

```shell
python -m bench.bench_fetch_token
python -m bench.bench_fetch_token_batched
python -m bench.bench_get_block
python -m bench.bench_get_block_batched
python -m bench.bench_get_logs
python -m bench.bench_serialize
```

## Deactivate Virtual Environment When Finished

```shell
deactivate
```
